{{/*
Copyright 2019-present Facebook Inc. All rights reserved.
This source code is licensed under the Apache 2.0 license found
in the LICENSE file in the root directory of this source tree.
*/}}

{{ define "entschema" }}
{{ template "header" $ }}

import (
	{{- with $.Config.Schema  }}
		"{{ . }}"
	{{- end }}
	{{ range $n := $.Nodes }}
		"{{ $.Config.Package }}/{{ $n.Package }}"
	{{- end }}

	"github.com/facebookincubator/ent"
)

// The init function reads all schema descriptors with runtime
// code (default values, validators or hooks) and stitches it
// to their package variables.
func init() {
{{ range $n := $.Nodes }}
	{{ $pkg :=  $n.Package }}
	{{- if or $n.HasDefault $n.HasValidators $n.NumHooks }}
		{{- if $n.NumHooks }}
			{{ print $pkg "Hooks" }} := {{ base $n.Schema }}.{{ $n.Name }}{}.Hooks()
			for i, h := range {{ print $pkg "Hooks" }} {
				{{ print $pkg ".Hooks" }}[i] = h
			}
		{{- end }}
		{{- with $n.MixedInWithDefaultOrValidator }}
			{{ $pkg }}Mixin := {{ base $n.Schema }}.{{ $n.Name }}{}.Mixin()
			{{ $pkg }}MixinFields := [...][]ent.Field{
				{{- range $i, $_ := xrange $n.NumMixin }}
					{{ $pkg }}Mixin[{{ $i }}].Fields(),
				{{- end }}
			}
		{{- end }}
		{{ $pkg }}Fields := {{ base $n.Schema }}.{{ $n.Name }}{}.Fields()
		{{ range $i, $f := $n.Fields -}}
			{{- $desc := print $pkg "Desc" $f.StructField -}}
			{{- /* enum default values handled near their declarations (in type package). */}}
			{{ if or (and $f.Default (not $f.IsEnum)) $f.UpdateDefault $f.Validators -}}
				{{- if $f.Position.MixedIn }}
				// {{ $desc }} is the schema descriptor for {{ $f.Name }} field.
				{{ $desc }} := {{ $pkg }}MixinFields[{{ $f.Position.MixinIndex }}][{{ $f.Position.Index }}].Descriptor()
			{{- else }}
				// {{ $desc }} is the schema descriptor for {{ $f.Name }} field.
				{{ $desc }} := {{ $pkg }}Fields[{{ $f.Position.Index }}].Descriptor()
			{{- end }}
		{{ end -}}
		{{ if and $f.Default (not $f.IsEnum) }}
			{{- $default := print $pkg "." $f.DefaultName -}}
			// {{ $default }} holds the default value on creation for the {{ $f.Name }} field.
			{{ $default }} = {{ $desc }}.Default.({{ if or $f.IsTime $f.IsUUID }}func() {{ end }}{{ $f.Type }})
		{{ end -}}
		{{ if $f.UpdateDefault }}
			{{- $default := print $pkg "." $f.UpdateDefaultName -}}
			// {{ $default }} holds the default value on update for the {{ $f.Name }} field.
			{{ $default }} = {{ $desc }}.UpdateDefault.({{ if $f.IsTime }}func() {{ end }}{{ $f.Type }})
		{{ end -}}
		{{ with $f.Validators -}}
			{{ $name := print $pkg "." $f.Validator -}}
			{{ $type :=  printf "func (%s) error" $f.Type -}}
			// {{ $name }} is a validator for the "{{ $f.Name }}" field. It is called by the builders before save.
			{{ if eq $f.Validators 1 -}}
				{{ $name }} = {{ $desc }}.Validators[0].({{ $type }})
			{{ else -}}
				{{ $name }} = func() {{ $type }} {
					validators := {{ $desc }}.Validators
					fns := [...]func({{ $f.Type }}) error {
						{{- range $j, $n := xrange $f.Validators }}
							validators[{{ $j }}].(func({{ $f.Type }}) error),
						{{- end }}
					}
					return func({{ $f.BuilderField }} {{ $f.Type }}) error {
						for _, fn := range fns {
							if err := fn({{ $f.BuilderField }}); err != nil {
								return err
							}
						}
						return nil
					}
				}()
			{{ end -}}
		{{ end -}}
	{{ end -}}
{{ end }}
{{ end }}
}

{{ end }}
